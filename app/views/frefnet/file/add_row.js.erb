<% filerowId = "#{params.fetch(:id)}-#{SecureRandom.hex(4)}" %>

var uploadContainer = $('#multiple-file-upload')
var inputCount = uploadContainer.find('input').length

generateFileUploadRow()

function generateFileUploadRow() {
  addRow();
  addHiddenFieldToForm("<%= params.fetch(:form_id) %>")
}

function addHiddenFieldToForm(formId) {
  var form = $('#' + formId);

  $('<input>').attr({
    type: 'hidden',
    name: 'frefnet_file_references',
    id: "<%= params.fetch(:id) %>-field-" + inputCount
  }).appendTo(form);
}

function addRow() {
  var fileRow = "<%= j render 'shared/multiple_file_upload_row', id: filerowId, required: true, class: 'form-control' %>"

  uploadContainer.append(fileRow);
}

$(document).ready(function () {
  new App.Lib.FileUploader({
    frefnetPresignUploadPath: '<%= frefnet.file_presign_upload_path %>',
    fileUploadId: "<%= filerowId %>",
    frefnetCallback: function (fileRefId) {
      $('#' + "<%= params.fetch(:id) %>-field-" + inputCount).val(fileRefId);
    }
  });
})